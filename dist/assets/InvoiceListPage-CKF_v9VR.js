import{a as ve,u as _e,m as be,K as ye,b as Se,p as De,o as d,c as u,d as n,t as r,e,i as P,f as A,j as y,x as c,A as B,g as U,v as ke,L as Q,H as p,F as Fe,r as Me,_ as Ce,k as C,M as Te,N as Ie,E as Ae,D as H,I as we,O as xe,l as Le,Q as $e,B as F,z as V,C as E,S as W}from"../gn-invoice.js";import{_ as S,u as Ne}from"./SortableHeader-rArAiVJm.js";import{_ as Pe,u as Be}from"./AppPagination-D5e3zrF_.js";import{_ as G}from"./AppBadge-BenmxPAy.js";import{_ as He}from"./PaymentBadges-DPh9th8s.js";import{_ as Ve,I as Ee}from"./InvoiceActions-ZkZBOAub.js";import{_ as Ue}from"./EmptyState-C5htIWVL.js";const ze={class:"page-header"},Oe={class:"page-header__title"},Re={class:"page-header__subtitle",style:{margin:"0"}},qe={class:"page-header__actions"},je=["innerHTML"],Ke=["innerHTML"],Qe={class:"filter-bar"},We={class:"autocomplete",style:{flex:"1","min-width":"250px"}},Ge=["placeholder"],Je={value:""},Xe={value:"standard"},Ye={value:"fictive"},Ze={value:""},et={key:0,value:"draft"},tt={key:1,value:"reserved"},st={key:2,value:"canceled"},ot={key:3,value:"sold"},at=["innerHTML"],lt={key:0},nt=["innerHTML"],it={key:1,class:"data-table-wrapper"},rt={class:"data-table"},ct={key:0,style:{width:"40px"}},dt={class:"form-checkbox"},ut=["checked"],mt={class:"text-center"},ft={key:0},ht={class:"form-checkbox"},pt=["checked","onChange"],gt={class:"text-truncate",style:{"max-width":"180px"}},vt={class:"font-medium"},_t={key:0,class:"amount--canceled"},bt={key:1},yt={class:"text-center"},At={__name:"InvoiceListPage",setup(St){const J=Te();Le();const g=ve(),D=_e(),X=be(),{showToast:w}=we(),Y=ye(),{t:l,tLabel:z}=Se(),{sortField:h,sortDir:v,toggleSort:Z,sortItems:ee}=Ne("createdAt","desc"),{currentPage:O,totalPages:te,paginate:se,resetPage:k}=Be(20),s=Ie({search:"",status:"",lifecycle:"",dateFrom:"",dateTo:"",paymentMethod:"",outstanding:!1,reserved:!1}),m=C(new Set),M=C(null),T=C(!1),x=C(""),L=C(""),$=C(!1);let N=()=>{};const oe=H(()=>s.search||s.status||s.lifecycle||s.dateFrom||s.dateTo||s.paymentMethod||s.outstanding||s.reserved),R=H(()=>{let t=D.isConsultant?D.getMyInvoices(g.invoices):[...g.invoices];if(s.search){const i=s.search.toLowerCase();t=t.filter(o=>{const f=g.customerById(o.customerId);return o.number.toLowerCase().includes(i)||f&&f.name.toLowerCase().includes(i)||f&&f.taxId.includes(i)})}s.status&&(t=t.filter(i=>i.status===s.status)),s.lifecycle&&(t=t.filter(i=>F(i).label.toLowerCase()===s.lifecycle)),(s.dateFrom||s.dateTo)&&(t=t.filter(i=>{const o=s.dateFrom,f=s.dateTo,pe=(!o||i.createdAt>=o)&&(!f||i.createdAt<=f),ge=i.payments.some(K=>(!o||K.date>=o)&&(!f||K.date<=f));return pe||ge})),s.paymentMethod&&(t=t.filter(i=>i.payments.some(o=>o.method===s.paymentMethod))),s.outstanding&&(t=t.filter(i=>i.status==="standard"&&F(i).label!=="Sold"&&E(i)-i.paidAmount>0)),s.reserved&&(t=t.filter(i=>F(i).label==="Reserved")),t=t.map(i=>{const o=g.customerById(i.customerId);return{...i,_customerName:o?o.name:"",_remaining:Math.max(0,E(i)-i.paidAmount)}});const a=h.value==="customer"?"_customerName":h.value==="remaining"?"_remaining":h.value;return ee(t,a)}),I=H(()=>se(R.value)),ae=H(()=>I.value.length>0&&I.value.every(t=>m.value.has(t.id)));function _(t){return M.value===t?"col-highlight":""}function b(t){Z(t),k()}const le=xe(()=>k(),400);function ne(){le()}function ie(){s.status==="standard"&&s.lifecycle==="draft"&&(s.lifecycle=""),s.status==="fictive"&&(s.lifecycle="draft"),s.status===""&&s.lifecycle==="draft"&&(s.lifecycle=""),k()}function re(){Object.assign(s,{search:"",status:"",lifecycle:"",dateFrom:"",dateTo:"",paymentMethod:"",outstanding:!1,reserved:!1}),M.value=null,k()}function ce(t){const a=g.customerById(t);return a?a.name:"â€”"}function q(t){return Math.max(0,E(t)-t.paidAmount)}function j(t){return W[t]||W.standard}function de(t){t.target.checked?I.value.forEach(a=>m.value.add(a.id)):m.value.clear()}function ue(t){m.value.has(t)?m.value.delete(t):m.value.add(t)}function me(t){x.value=l("msg.titleMarkSold"),L.value=l("msg.confirmMarkSold",{number:t.number}),$.value=!1,N=()=>{const a=g.invoiceById(t.id);if(a){if(a.totalAmount-a.paidAmount>0){w("warning",l("msg.outstandingWarning",{number:a.number}));return}a.items.forEach(i=>{i.itemStatus!=="none"&&(i.itemStatus="sold")}),a.saleDate=a.saleDate||new Date().toISOString().split("T")[0],a.soldDate=a.soldDate||new Date().toISOString().split("T")[0],a.lifecycleStatus="sold",g.saveInvoice({...a}),w("success",l("msg.invoiceMarkedSold",{number:a.number})),Y.push({type:"invoice",titleKey:"notif.invoiceCompleted",message:a.number,icon:"check-circle",invoiceId:a.id})}},T.value=!0}function fe(t){x.value=l("msg.titleDeleteInvoice"),L.value=l("msg.confirmDelete",{number:t.number}),$.value=!0,N=()=>{g.deleteInvoice(t.id),m.value.delete(t.id),w("success",l("msg.invoiceDeleted"))},T.value=!0}function he(){x.value=l("msg.titleDeleteSelected"),L.value=l("msg.confirmBulkDelete",{n:m.value.size}),$.value=!0,N=()=>{m.value.forEach(t=>g.deleteInvoice(t)),m.value.clear(),w("success",l("msg.invoicesDeleted"))},T.value=!0}return De(()=>{M.value=X.consumeDrilldownHighlight();const t=J.query;if(!M.value){const a={outstanding:"remaining",reserved:"lifecycle"};t.filter&&a[t.filter]?M.value=a[t.filter]:t.paymentMethod&&(M.value="payment")}t.filter==="standard"?s.status="standard":t.filter==="reserved"?(s.status="standard",s.lifecycle="reserved"):t.filter==="outstanding"?(s.status="standard",s.outstanding=!0):(t.filter==="sold"||t.filter==="completed")&&(s.status="standard",s.lifecycle="sold"),t.paymentMethod&&(s.status="standard",s.paymentMethod=t.paymentMethod),t.dateFrom&&(s.dateFrom=t.dateFrom),t.dateTo&&(s.dateTo=t.dateTo)}),(t,a)=>{const i=Ae("router-link");return d(),u("div",null,[n("div",ze,[n("div",null,[n("h1",Oe,r(e(D).isConsultant?e(l)("page.invoices.myTitle"):e(l)("page.invoices.title")),1),n("p",Re,r(e(D).isConsultant?e(l)("page.invoices.mySubtitle"):e(l)("page.invoices.subtitle")),1)]),n("div",qe,[m.value.size>0&&!e(D).isConsultant?(d(),u("button",{key:0,class:"btn btn--danger btn--sm",onClick:he},[n("span",{innerHTML:e(P)("trash-2",14)},null,8,je),A(" "+r(e(l)("btn.deleteSelected",{n:m.value.size})),1)])):y("",!0),c(i,{to:"/invoices/new",class:"btn btn--primary"},{default:B(()=>[n("span",{innerHTML:e(P)("plus",16)},null,8,Ke),A(" "+r(e(l)("btn.newInvoice")),1)]),_:1})])]),n("div",Qe,[n("div",We,[U(n("input",{type:"text",class:"form-input form-input--search","onUpdate:modelValue":a[0]||(a[0]=o=>s.search=o),onInput:ne,placeholder:e(l)("page.invoices.searchPlaceholder")},null,40,Ge),[[ke,s.search]])]),U(n("select",{class:"form-select","onUpdate:modelValue":a[1]||(a[1]=o=>s.status=o),onChange:ie},[n("option",Je,r(e(l)("filter.allTypes")),1),n("option",Xe,r(e(l)("filter.standard")),1),n("option",Ye,r(e(l)("filter.fictive")),1)],544),[[Q,s.status]]),U(n("select",{class:"form-select","onUpdate:modelValue":a[2]||(a[2]=o=>s.lifecycle=o),onChange:a[3]||(a[3]=(...o)=>e(k)&&e(k)(...o))},[n("option",Ze,r(e(l)("filter.allStatus")),1),s.status!=="standard"?(d(),u("option",et,r(e(l)("filter.draft")),1)):y("",!0),s.status!=="fictive"?(d(),u("option",tt,r(e(l)("filter.reserved")),1)):y("",!0),s.status!=="fictive"?(d(),u("option",st,r(e(l)("filter.canceled")),1)):y("",!0),s.status!=="fictive"?(d(),u("option",ot,r(e(l)("filter.sold")),1)):y("",!0)],544),[[Q,s.lifecycle]]),c(Ve,{dateFrom:s.dateFrom,"onUpdate:dateFrom":a[4]||(a[4]=o=>s.dateFrom=o),dateTo:s.dateTo,"onUpdate:dateTo":a[5]||(a[5]=o=>s.dateTo=o),prefix:"inv",onChange:e(k)},null,8,["dateFrom","dateTo","onChange"]),oe.value?(d(),u("button",{key:0,class:"btn btn--ghost btn--sm",onClick:re},[n("span",{innerHTML:e(P)("x",14)},null,8,at),A(" "+r(e(l)("btn.reset")),1)])):y("",!0)]),I.value.length===0?(d(),u("div",lt,[c(Ue,{title:e(l)("page.invoices.notFound"),message:e(l)("page.invoices.notFoundMsg")},{default:B(()=>[c(i,{to:"/invoices/new",class:"btn btn--primary"},{default:B(()=>[n("span",{innerHTML:e(P)("plus",16)},null,8,nt),A(" "+r(e(l)("btn.newInvoice")),1)]),_:1})]),_:1},8,["title","message"])])):(d(),u("div",it,[n("table",rt,[n("thead",null,[n("tr",null,[e(D).isConsultant?y("",!0):(d(),u("th",ct,[n("label",dt,[n("input",{type:"checkbox",checked:ae.value,onChange:de},null,40,ut)])])),c(S,{label:e(l)("col.invoiceNumber"),field:"number",sortField:e(h),sortDir:e(v),onSort:b,class:p(_("number"))},null,8,["label","sortField","sortDir","class"]),c(S,{label:e(l)("col.date"),field:"createdAt",sortField:e(h),sortDir:e(v),onSort:b},null,8,["label","sortField","sortDir"]),c(S,{label:e(l)("col.customer"),field:"customer",sortField:e(h),sortDir:e(v),onSort:b},null,8,["label","sortField","sortDir"]),c(S,{label:e(l)("col.total"),field:"totalAmount",sortField:e(h),sortDir:e(v),onSort:b},null,8,["label","sortField","sortDir"]),c(S,{label:e(l)("col.paid"),field:"paidAmount",sortField:e(h),sortDir:e(v),onSort:b},null,8,["label","sortField","sortDir"]),c(S,{label:e(l)("col.remaining"),field:"remaining",sortField:e(h),sortDir:e(v),onSort:b,class:p(_("remaining"))},null,8,["label","sortField","sortDir","class"]),c(S,{label:e(l)("col.type"),field:"status",sortField:e(h),sortDir:e(v),onSort:b},null,8,["label","sortField","sortDir"]),c(S,{label:e(l)("col.status"),field:"lifecycleStatus",sortField:e(h),sortDir:e(v),onSort:b,class:p(_("lifecycle"))},null,8,["label","sortField","sortDir","class"]),n("th",{class:p(_("payment"))},r(e(l)("col.payment")),3),n("th",mt,r(e(l)("col.actions")),1)])]),n("tbody",null,[(d(!0),u(Fe,null,Me(I.value,o=>(d(),u("tr",{key:o.id,class:p({selected:m.value.has(o.id)})},[e(D).isConsultant?y("",!0):(d(),u("td",ft,[n("label",ht,[n("input",{type:"checkbox",checked:m.value.has(o.id),onChange:f=>ue(o.id)},null,40,pt)])])),n("td",{class:p(_("number"))},[c(i,{to:`/invoices/${o.id}`,style:{"font-weight":"600"}},{default:B(()=>[A(r(o.number),1)]),_:2},1032,["to"])],2),n("td",null,r(e($e)(o.createdAt)),1),n("td",gt,r(ce(o.customerId)),1),n("td",vt,[e(F)(o).label==="Canceled"?(d(),u("span",_t,r(e(V)(o.totalAmount)),1)):(d(),u("span",bt,r(e(V)(e(E)(o))),1))]),n("td",{class:p({"amount--canceled":e(F)(o).label==="Canceled"})},r(e(V)(o.paidAmount)),3),n("td",{class:p([_("remaining"),q(o)>0?"text-danger font-semibold":""])},r(e(V)(q(o))),3),n("td",null,[c(G,{label:e(z)(j(o.status)),color:j(o.status).color},null,8,["label","color"])]),n("td",{class:p(_("lifecycle"))},[c(G,{label:e(z)(e(F)(o)),color:e(F)(o).color,dot:!0},null,8,["label","color"])],2),n("td",{class:p(_("payment"))},[c(He,{payments:o.payments,totalAmount:o.totalAmount,filterMethod:s.paymentMethod,filterDateFrom:s.dateFrom,filterDateTo:s.dateTo},null,8,["payments","totalAmount","filterMethod","filterDateFrom","filterDateTo"])],2),n("td",yt,[c(Ee,{invoice:o,onView:f=>t.$router.push(`/invoices/${o.id}`),onEdit:f=>t.$router.push(`/invoices/${o.id}/edit`),onMarkSold:f=>me(o),onDelete:f=>fe(o)},null,8,["invoice","onView","onEdit","onMarkSold","onDelete"])])],2))),128))])]),c(Pe,{currentPage:e(O),totalPages:e(te),total:R.value.length,onPageChange:a[6]||(a[6]=o=>O.value=o)},null,8,["currentPage","totalPages","total"])])),c(Ce,{visible:T.value,"onUpdate:visible":a[7]||(a[7]=o=>T.value=o),title:x.value,message:L.value,danger:$.value,onConfirm:e(N)},null,8,["visible","title","message","danger","onConfirm"])])}}};export{At as default};
